name: Build & Release

on:
  push:
    tags:
      - "v*"           # Trigger build+release on version tags: v0.2.0, v1.0.0, etc.
    branches:
      - main           # Trigger unit tests on every push to main
  pull_request:
    branches:
      - main
  workflow_dispatch:   # Allow manual triggering from the GitHub UI

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write   # required for softprops/action-gh-release to create releases

    steps:
      # -----------------------------------------------------------------------
      # 1. Checkout
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2. Install Node.js
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      # -----------------------------------------------------------------------
      # 3. Install Rust stable toolchain
      # -----------------------------------------------------------------------
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      # -----------------------------------------------------------------------
      # 4. Cache Rust build artifacts
      # -----------------------------------------------------------------------
      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      # -----------------------------------------------------------------------
      # 5. Generate Cargo.lock (ensures reproducible resolution with pinned versions)
      # -----------------------------------------------------------------------
      - name: Generate Cargo.lock
        run: cargo generate-lockfile --manifest-path src-tauri/Cargo.toml

      # -----------------------------------------------------------------------
      # 6. Install npm dependencies
      # -----------------------------------------------------------------------
      - name: Install npm dependencies
        run: npm install

      # -----------------------------------------------------------------------
      # 7. Build frontend (Vite)
      # -----------------------------------------------------------------------
      - name: Build frontend
        run: npm run build

      # -----------------------------------------------------------------------
      # 8. Build Tauri app (Rust compile + NSIS bundle)
      #    TAURI_SIGNING_PRIVATE_KEY is intentionally empty — we're not using
      #    Tauri's update signing for now (pubkey left blank in tauri.conf.json).
      #    The updater endpoint just checks the version number via latest.json.
      # -----------------------------------------------------------------------
      - name: Build Tauri app
        run: npx tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ""
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""

      # -----------------------------------------------------------------------
      # 8. Generate latest.json for the in-app updater.
      #    The updater plugin fetches this file from the release assets and
      #    compares its "version" field against the running app's version.
      #    Format: { "version": "0.2.0", "notes": "...", "pub_date": "...",
      #              "platforms": { "windows-x86_64": { "url": "...", "signature": "" } } }
      # -----------------------------------------------------------------------
      - name: Generate latest.json
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v',''
          $tag     = "${{ github.ref_name }}"
          $exeName = Get-ChildItem src-tauri/target/release/bundle/nsis/*.exe |
                     Select-Object -First 1 -ExpandProperty Name
          $url     = "https://github.com/MFredin/CombatCoaching/releases/download/$tag/$exeName"
          $date    = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          $json = [ordered]@{
            version   = $version
            notes     = "See release notes at https://github.com/MFredin/CombatCoaching/releases/tag/$tag"
            pub_date  = $date
            platforms = [ordered]@{
              "windows-x86_64" = [ordered]@{
                url       = $url
                signature = ""
              }
            }
          } | ConvertTo-Json -Depth 5
          $json | Out-File -FilePath latest.json -Encoding utf8
          Write-Host "Generated latest.json:"
          Get-Content latest.json

      # -----------------------------------------------------------------------
      # 9. Package addon as a zip for easy installation
      #    Creates CombatCoach-addon.zip with the correct folder structure:
      #    CombatCoach/CombatCoach.toc  +  CombatCoach/CombatCoach.lua
      #    Users extract this directly into Interface/AddOns/
      # -----------------------------------------------------------------------
      - name: Package addon zip
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "addon-pkg\CombatCoach" -Force | Out-Null
          Copy-Item "addon\CombatCoach.toc" "addon-pkg\CombatCoach\"
          Copy-Item "addon\CombatCoach.lua" "addon-pkg\CombatCoach\"
          Compress-Archive -Path "addon-pkg\CombatCoach" -DestinationPath "CombatCoach-addon.zip" -Force
          Write-Host "Addon zip created:"
          Get-ChildItem CombatCoach-addon.zip

      # -----------------------------------------------------------------------
      # 10. Create GitHub Release and upload installer + addon + latest.json
      # -----------------------------------------------------------------------
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          name: "CombatLedger Live Coach ${{ github.ref_name }}"
          body: |
            ## CombatLedger Live Coach ${{ github.ref_name }}

            ### Installation
            1. Download and run the `.exe` installer below
            2. Launch **CombatLedger Live Coach** from the Start Menu
            3. On first run, click **Auto-detect** to find your WoW installation
            4. **Install the addon** (strongly recommended for real-time coaching):
               - Download `CombatCoach-addon.zip` from the assets below
               - Extract it into `World of Warcraft\_retail_\Interface\AddOns\`
               - You should now have `Interface\AddOns\CombatCoach\CombatCoach.toc`
               - Log into WoW and type `/cc` to confirm the addon is working
               - Make sure combat logging is enabled (`/combatlog`)

            ### What the addon does
            The CombatCoach addon flushes WoW's combat log buffer to disk every second
            during combat. Without it, WoW batches log writes and the app may not receive
            events until combat ends. With it, coaching advice appears **in real time**.

            ### What's in this release
            - Real-time combat log tailing (< 50ms latency with addon)
            - Coaching rules: avoidable damage, GCD gaps, cooldown drift
            - Transparent always-on-top overlay (WoW must use Windowed Fullscreen)
            - Drag-and-drop overlay panel layout editor with opacity and scale controls
            - In-app update checker (Settings sidebar → Updates)
            - Log files written to `%APPDATA%\com.combatledger.livecoach\logs\`

            ### Requirements
            - Windows 10 / 11
            - World of Warcraft (retail) in **Windowed (Fullscreen)** mode
            - WebView2 runtime (included with Windows 11 and Microsoft Edge)
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            CombatCoach-addon.zip
            latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # 11. Upload installer as workflow artifact (available on every run)
      # -----------------------------------------------------------------------
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: CombatLedger-Windows-Installer
          path: src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Rust unit tests — run on every push to main and on PRs
  # ---------------------------------------------------------------------------
  test:
    name: Rust Unit Tests
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      - name: Generate Cargo.lock
        run: cargo generate-lockfile --manifest-path src-tauri/Cargo.toml

      # npm install is needed because tauri-build (build.rs) requires the
      # frontend dist to exist for the Tauri context macro to compile.
      # We skip the full frontend build — just need node_modules present.
      - name: Install npm dependencies
        run: npm install

      - name: Run Rust unit tests
        run: cargo test --manifest-path src-tauri/Cargo.toml --lib --locked
        env:
          TAURI_SKIP_DEVSERVER_CHECK: "true"

      # -----------------------------------------------------------------------
      # Bootstrap step: upload the Cargo.lock generated by cargo test so it
      # can be committed to the repo for stable rust-cache keys.
      # Once src-tauri/Cargo.lock is committed, this step can be removed.
      # -----------------------------------------------------------------------
      - name: Upload Cargo.lock (bootstrap)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cargo-lock
          path: src-tauri/Cargo.lock
          retention-days: 7
