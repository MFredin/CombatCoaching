name: Build & Release

on:
  push:
    tags:
      - "v*"           # Trigger on version tags: v0.1.0, v1.0.0, etc.
  workflow_dispatch:   # Allow manual triggering from the GitHub UI

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
      # -----------------------------------------------------------------------
      # 1. Checkout
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2. Install Node.js (no cache — we have no package-lock.json)
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      # -----------------------------------------------------------------------
      # 3. Install Rust stable toolchain
      # -----------------------------------------------------------------------
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      # -----------------------------------------------------------------------
      # 4. Cache Rust build artifacts
      # -----------------------------------------------------------------------
      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      # -----------------------------------------------------------------------
      # 5. Install npm dependencies and generate package-lock.json
      # -----------------------------------------------------------------------
      - name: Install npm dependencies
        run: npm install

      # -----------------------------------------------------------------------
      # 6. Build frontend (Vite)
      # -----------------------------------------------------------------------
      - name: Build frontend
        run: npm run build

      # -----------------------------------------------------------------------
      # 7. Build Tauri app (Rust compile + NSIS bundle)
      #    We call cargo tauri build directly to avoid tauri-action's
      #    internal Node/npm setup which requires a package-lock.json.
      # -----------------------------------------------------------------------
      - name: Build Tauri app
        run: npx tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ""
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""

      # -----------------------------------------------------------------------
      # 8. Create GitHub Release and upload installer (tag pushes only)
      # -----------------------------------------------------------------------
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: false
          name: "CombatLedger Live Coach ${{ github.ref_name }}"
          body: |
            ## CombatLedger Live Coach ${{ github.ref_name }}

            ### Installation
            1. Download and run the `.exe` installer below
            2. Launch **CombatLedger Live Coach** from the Start Menu
            3. On first run, click **Auto-detect** to find your WoW installation
            4. Copy the `addon/CombatCoach` folder into your WoW `Interface/AddOns/` directory
            5. Log into WoW and type `/cc` to confirm the addon is working

            ### What's in this release
            - Real-time combat log tailing (< 50ms latency)
            - Three coaching rules: avoidable damage, GCD gaps, cooldown drift
            - Transparent always-on-top overlay (WoW must use Windowed Fullscreen)
            - Drag-and-drop overlay panel layout editor in the settings window

            ### Requirements
            - Windows 10 / 11
            - World of Warcraft (retail) in **Windowed (Fullscreen)** mode
            - WebView2 runtime (included with Windows 11 and Microsoft Edge)
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # 9. Upload installer as workflow artifact (available on every run)
      # -----------------------------------------------------------------------
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: CombatLedger-Windows-Installer
          path: src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Rust unit tests — run on every push to main and on PRs
  # ---------------------------------------------------------------------------
  test:
    name: Rust Unit Tests
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      # npm install is needed because tauri-build (build.rs) requires the
      # frontend dist to exist for the Tauri context macro to compile.
      # We skip the full frontend build — just need node_modules present.
      - name: Install npm dependencies
        run: npm install

      - name: Run Rust unit tests
        run: cargo test --manifest-path src-tauri/Cargo.toml
        env:
          TAURI_SKIP_DEVSERVER_CHECK: "true"
